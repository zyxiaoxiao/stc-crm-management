<template>
	<div v-loading="loading" class="flex-1 all-height flex-column">
		<div v-if="props.tableList.tableToolbar.whole" class="flex-row flx-center" style="margin-bottom: 10px; margin-top: 10px">
			<div class="flex-1">
				<div v-if="props.tableList.tableToolbar.left" style="text-align: left">
					<slot
						name="tableHeaderLleft"
						:ids="selectListIds"
						:selectList="selectList"
						:getEditSelectList="getEditSelectList"
						:isSelected="isSelected"
					>
					</slot>
				</div>
			</div>
			<div v-if="props.tableList.tableToolbar.right" class="flx-center" style="margin-right: 2px">
				<el-tooltip
					v-if="props.tableList.tableToolbar.right_download"
					:content="$t('SRM_ExportMDM')"
					placement="top"
					:show-after="500"
				>
					<el-button @click="tableExport" class="main-table-header-ri-button" size="small" icon="Download" />
				</el-tooltip>
				<el-tooltip
					v-if="props.tableList.tableToolbar.right_filter"
					:content="$t('Search_QuickSearch')"
					placement="top"
					:show-after="500"
				>
					<el-button @click="tableFilter" class="main-table-header-ri-button" size="small" icon="Filter" />
				</el-tooltip>
				<el-tooltip
					v-if="props.tableList.tableToolbar.right_query"
					:content="$t('Search_FuzzySearch')"
					placement="top"
					:show-after="500"
				>
					<el-button @click="quickQuery" class="main-table-header-ri-button" size="small" icon="Search" />
				</el-tooltip>
				<el-tooltip
					v-if="props.tableList.tableToolbar.right_empty"
					:content="$t('Search_ClearSearch')"
					placement="top"
					:show-after="500"
				>
					<el-button @click="tableResetSearch" class="main-table-header-ri-button" size="small" icon="ZoomOut" />
				</el-tooltip>
				<slot name="tableHeaderRight"></slot>
			</div>
		</div>
		<el-table
			ref="tableRef"
			id="tableRef"
			border
			stripe
			highlight-current-row
			scrollbar-always-on
			:header-cell-style="{ background: '#f8f8f9', color: '#606266', fontWeight: 700 }"
			class="flex-1"
			:style="{ marginTop: props.tableList.tableToolbar.whole ? '0px' : '10px', minHeight: '150px' }"
			:data="tableList.tableData"
			@current-change="currentChange"
			@selection-change="selectionChange"
			@select="select"
			@row-click="rowClick"
			@cell-click="cellClick"
			:row-key="listId"
			:cell-class-name="cellClassName"
			table-layout="auto"
		>
			<template v-for="item in tableList.tableColumns" :key="item">
				<!-- selection || index -->

				<el-table-column
					v-if="item.type == 'selection' || item.type == 'index'"
					:type="item.type"
					:label="item.label ? $t(item.label) : item.title"
					:width="item.width"
					:fixed="item.fixed"
				>
				</el-table-column>

				<!-- workflowStatus -->
				<el-table-column
					v-else-if="item.type == 'workflowStatus'"
					:prop="item.prop"
					:label="item.label ? $t(item.label) : item.title"
					:width="item.width"
					:fixed="item.fixed"
				>
					<template #default="scope">
						<el-tooltip class="box-item" effect="dark" :content="workflowStatusText(scope.row[item.prop])" placement="right">
							<span @click="workflowStatus(item.prop, scope.row)">
								<i
									v-if="scope.row[item.prop] == '0'"
									class="iconfont layui-icon-extend-upArrow font-size-base"
									style="color: #00aa00"
								></i>
								<i
									v-else-if="scope.row[item.prop] == '1'"
									class="iconfont layui-icon-extend-rightArrow font-size-base"
									style="color: #00aa00"
								></i>
								<i
									v-else-if="scope.row[item.prop] == '2'"
									class="iconfont layui-icon-extend-zhengque font-size-base"
									style="color: #00aa00"
								></i>
								<i
									v-else-if="scope.row[item.prop] == '-1'"
									class="iconfont layui-icon-extend-cuowu font-size-base"
									style="color: #ff0000"
								></i>
							</span>
						</el-tooltip>
					</template>
				</el-table-column>

				<!-- Link -->
				<el-table-column
					v-else-if="item.type == 'Link'"
					show-overflow-tooltip
					:prop="item.prop"
					:width="item.width"
					:fixed="item.fixed"
				>
					<template #header>
						<div style="white-space: nowrap" @click="tableSor(item.prop)">
							<label>{{ item.label ? $t(item.label) : item.title }}</label>
							<span class="caret-wrapper">
								<i class="sort-caret ascending"></i>
								<i class="sort-caret descending"></i>
							</span>
						</div>
						<!-- 表单组件 -->
						<div v-show="tablePropSearchShow">
							<el-input v-model="tablePropSearch[item.prop]" size="small" />
						</div>
					</template>
					<template #default="scope">
						<span>
							<el-link @click="linkDetailbg(item.prop, scope.row)" type="primary">{{ scope.row[item.prop] }} </el-link>
						</span>
					</template>
				</el-table-column>

				<!-- operation -->
				<el-table-column v-else-if="item.type == 'operation'" :prop="item.prop" :width="item.width" :fixed="item.fixed">
					<template #header>
						<div class="flx-center">
							<label style="color: #409eff">{{ item.label ? $t(item.label) : item.title }}</label>
							<!-- <el-button type="primary">{{ item.label ? $t(item.label) : item.title }}</el-button> -->
						</div>
					</template>
					<template #default="scope">
						<!-- <el-scrollbar>
							<div class="flex-row" :style="{ height: operationColumnHeight + `px` }">
								<slot name="operation" :row="scope.row"></slot>
							
						</el-scrollbar> -->
						<div class="flex-row">
							<slot name="operation" :row="scope.row"></slot>
						</div>
					</template>
				</el-table-column>

				<!-- Custom -->
				<el-table-column
					v-else-if="item.type == 'Custom'"
					show-overflow-tooltip
					:prop="item.prop"
					:width="item.width"
					:fixed="item.fixed"
				>
					<template #header>
						<div style="white-space: nowrap" @click="tableSor(item.prop)">
							<label>{{ item.label ? $t(item.label) : item.title }}</label>
							<span class="caret-wrapper">
								<i class="sort-caret ascending"></i>
								<i class="sort-caret descending"></i>
							</span>
						</div>
						<!-- 表单组件 -->
						<div v-show="tablePropSearchShow">
							<el-select v-if="item.type == 'Select'" v-model="tablePropSearch[item.prop]" size="small">
								<template v-for="item1 in item.typeData" :key="item">
									<el-option
										:label="
											item.label != 'i18nCustomerapplicationCustomerCreateInformationArea' &&
											item.label != 'i18nCustomerapplicationCustomerCreateInformationProvince' &&
											item.label != 'i18nCustomerapplicationCustomerCreateInformationCityCenter' &&
											item1.label
												? $t(item1.label)
												: item1.label
										"
										:value="item1.value"
									/>
								</template>
							</el-select>
							<el-date-picker
								v-else-if="item.type == 'Date'"
								v-model="tablePropSearch[item.prop]"
								type="date"
								format="YYYY-MM-DD"
								size="small"
							/>
							<el-date-picker
								v-else-if="item.type == 'DateTime'"
								v-model="tablePropSearch[item.prop]"
								type="datetime"
								format="YYYY-MM-DD hh:mm:ss"
								size="small"
							/>
							<el-input-number
								v-else-if="item.type == 'Number'"
								controls-position="right"
								:min="0"
								v-model="tablePropSearch[item.prop]"
								size="small"
							/>
							<el-input v-else v-model="tablePropSearch[item.prop]" size="small" />
						</div>
					</template>
					<template #default="scope">
						<slot name="Custom" :row="scope.row" :column="item.prop"></slot>
					</template>
				</el-table-column>

				<!-- other -->
				<el-table-column
					v-else-if="item.type && item.prop && !item.isHide"
					show-overflow-tooltip
					:prop="item.prop"
					:width="item.width"
				>
					<template #header>
						<div style="white-space: nowrap" @click="tableSor(item.prop)">
							<label>{{ item.label ? $t(item.label) : item.title }}</label>
							<el-icon v-if="tableList.edit && item.edit"><Edit /> </el-icon>
							<span class="caret-wrapper">
								<i class="sort-caret ascending"></i>
								<i class="sort-caret descending"></i>
							</span>
						</div>
						<!-- 表单组件 -->
						<div v-show="tablePropSearchShow">
							<el-select v-if="item.type == 'Select'" v-model="tablePropSearch[item.prop]" size="small">
								<template v-for="item1 in item.typeData" :key="item">
									<el-option
										:label="
											item.label != 'i18nCustomerapplicationCustomerCreateInformationArea' &&
											item.label != 'i18nCustomerapplicationCustomerCreateInformationProvince' &&
											item.label != 'i18nCustomerapplicationCustomerCreateInformationCityCenter' &&
											item1.label
												? $t(item1.label)
												: item1.label
										"
										:value="item1.value"
									/>
								</template>
							</el-select>
							<el-date-picker
								v-else-if="item.type == 'Date'"
								v-model="tablePropSearch[item.prop]"
								type="date"
								format="YYYY-MM-DD"
								size="small"
							/>
							<el-date-picker
								v-else-if="item.type == 'DateTime'"
								v-model="tablePropSearch[item.prop]"
								type="datetime"
								format="YYYY-MM-DD hh:mm:ss"
								size="small"
							/>
							<el-input-number
								v-else-if="item.type == 'Number'"
								controls-position="right"
								:min="0"
								v-model="tablePropSearch[item.prop]"
								size="small"
							/>
							<el-input v-else v-model="tablePropSearch[item.prop]" size="small" />
						</div>
					</template>
					<template v-if="tableList.edit && item.edit" #default="scope">
						<span v-show="!scope.row.editShow[item.prop]">
							<template v-if="item.type == 'Select'">{{
								item.label != "i18nCustomerapplicationCustomerCreateInformationArea" &&
								item.label != "i18nCustomerapplicationCustomerCreateInformationProvince" &&
								item.label != "i18nCustomerapplicationCustomerCreateInformationCityCenter"
									? $t(selectText(scope.row[item.prop], item.typeData))
									: selectText(scope.row[item.prop], item.typeData)
							}}</template>
							<template v-else>{{ scope.row[item.prop] }}</template>
						</span>
						<!-- 表单组件 -->
						<div v-show="scope.row.editShow[item.prop]">
							<el-select
								v-if="item.type == 'Select'"
								v-model="scope.row[item.prop]"
								:ref="el => setFormComponentRef(el, scope.row.rowIndex + item.prop)"
							>
								<template v-for="item1 in item.typeData" :key="item">
									<el-option
										:label="
											item.label != 'i18nCustomerapplicationCustomerCreateInformationArea' &&
											item.label != 'i18nCustomerapplicationCustomerCreateInformationProvince' &&
											item.label != 'i18nCustomerapplicationCustomerCreateInformationCityCenter' &&
											item1.label
												? $t(item1.label)
												: item1.label
										"
										:value="item1.value"
									/>
								</template>
							</el-select>
							<el-date-picker
								v-else-if="item.type == 'Date'"
								v-model="scope.row[item.prop]"
								type="date"
								format="YYYY-MM-DD"
								value-format="YYYY-MM-DD"
								:ref="el => setFormComponentRef(el, scope.row.rowIndex + item.prop)"
							/>
							<el-date-picker
								v-else-if="item.type == 'DateTime'"
								v-model="scope.row[item.prop]"
								type="datetime"
								format="YYYY-MM-DD hh:mm:ss"
								value-format="YYYY-MM-DD hh:mm:ss"
								:ref="el => setFormComponentRef(el, scope.row.rowIndex + item.prop)"
							/>
							<el-input-number
								v-else-if="item.type == 'Number'"
								controls-position="right"
								:min="0"
								v-model="scope.row[item.prop]"
								:ref="el => setFormComponentRef(el, scope.row.rowIndex + item.prop)"
							/>
							<el-input
								v-else
								v-model="scope.row[item.prop]"
								:ref="el => setFormComponentRef(el, scope.row.rowIndex + item.prop)"
							/>
						</div>
					</template>
					<template v-else #default="scope">
						<span>
							<template v-if="item.type == 'Select'">{{
								item.label != "i18nCustomerapplicationCustomerCreateInformationArea" &&
								item.label != "i18nCustomerapplicationCustomerCreateInformationProvince" &&
								item.label != "i18nCustomerapplicationCustomerCreateInformationCityCenter"
									? $t(selectText(scope.row[item.prop], item.typeData))
									: selectText(scope.row[item.prop], item.typeData)
							}}</template>
							<template v-else>{{ scope.row[item.prop] }}</template>
						</span>
					</template>
				</el-table-column>
			</template>
		</el-table>
		<div v-if="tableList.isPaging" class="flex-row main-pagination-block">
			<div class="flex-1"></div>
			<el-pagination
				:small="paginationSmall"
				:currentPage="params.page"
				:page-size="params.limit"
				:page-sizes="[25, 50, 100, 200]"
				:background="true"
				layout="total, sizes, prev, pager, next, jumper"
				:total="params.total"
				@size-change="handleSizeChange"
				@current-change="handleCurrentChange"
			/>
		</div>
	</div>
</template>

<script setup name="zTable">
import { exportDataSourceToExcel } from "/src/utils/exportExcel.js";
import { onMounted, ref, computed, reactive, watch } from "vue";
import qs from "qs";
import http from "@/api/index.js";
import { useI18n } from "vue-i18n";
import { GlobalStore } from "@/store/globalStore.js";

const i18n = useI18n();
const globalStore = GlobalStore();
const tableRef = ref();

//分页组件大小
const paginationSmall = computed(() => {
	if (globalStore.assemblySize == "small") {
		return true;
	}
	return false;
});

// 表格加载 loading
const loading = ref(false);

//排序
let sortvalue = ref("ascending");
//显示隐藏快捷查询
const tablePropSearchShow = ref(false);

//请求头配置
let config = reactive({
	headers: {
		noLoading: true //隐藏加载--
	}
});

//参数
let params = reactive({
	jsonString: ""
});
// 快捷查询
let tablePropSearch = reactive({});
// 是否选中数据
const isSelected = ref(false);
// 选中的数据列表
const selectList = ref([]);
//选中原始的数据源
const selectRowArr = ref([]);

//可编辑时，表单组件ref数组
const formComponentRef = {};

// 父组件传入的参数
const props = defineProps({
	tableList: {
		isPaging: true, //是否显示分页
		edit: false, //当前表格是否可编辑
		noLoading: true, //true为 隐藏加载
		isRadio: false, // 是否设置单选，false不设置
		isRequest: false, //页面渲染完成，是否调请求接口，false不调
		//表格工具栏
		tableToolbar: {
			whole: true, //显示全部表格工具栏
			left: true, //显示左表格工具栏
			right: true, //显示右全部表格工具栏
			right_download: true, //显示右下载
			right_filter: true, //显示右过滤
			right_query: true, //显示右查询
			right_empty: true //显示右清空
		},
		//请求属性
		httpAttribute: {},
		//表格表头
		tableColumns: [],
		//快捷查询
		tablePropSearch: {},
		// 表格数据
		tableData: []
	}
});

//显示分页
if (props.tableList.isPaging !== false) {
	props.tableList.isPaging = true;
	// 当前页数
	params.page = 1;
	// 每页显示条数
	params.limit = 25;
	// 总条数
	params.total = 0;
	//开始数量
	params.start = 0;
}

//显示加载--
if (props.tableList.noLoading === false) {
	config.headers.noLoading = false;
}

//先判断父组件传入的参数，表格工具栏,默认全部显示
if (props.tableList.tableToolbar) {
	typeof props.tableList.tableToolbar.whole == "undefined" ? (props.tableList.tableToolbar.whole = true) : false;
	typeof props.tableList.tableToolbar.left == "undefined" ? (props.tableList.tableToolbar.left = true) : false;
	typeof props.tableList.tableToolbar.right == "undefined" ? (props.tableList.tableToolbar.right = true) : false;
	typeof props.tableList.tableToolbar.right_download == "undefined"
		? (props.tableList.tableToolbar.right_download = true)
		: false;
	typeof props.tableList.tableToolbar.right_filter == "undefined" ? (props.tableList.tableToolbar.right_filter = true) : false;
	typeof props.tableList.tableToolbar.right_query == "undefined" ? (props.tableList.tableToolbar.right_query = true) : false;
	typeof props.tableList.tableToolbar.right_empty == "undefined" ? (props.tableList.tableToolbar.right_empty = true) : false;
} else {
	props.tableList.tableToolbar = {
		whole: true,
		left: true,
		right: true,
		right_download: true,
		right_filter: true,
		right_query: true,
		right_empty: true
	};
}

//判断 是否单选 是否隐藏全选
let RadioDisplay = ref("block");
if (props.tableList.isRadio) {
	RadioDisplay = "none";
}

if (props.tableList.tablePropSearch) {
	tablePropSearch = props.tableList.tablePropSearch;
}

//获取id字段
let listId = "id";
// 获取表头字段
let tableHanderArr = ["submitcorp", "auditflag", "workflowid"];

//获取表头可编辑字段
let tableHanderEditArr = [];
props.tableList.tableColumns.forEach(item => {
	//获取id
	if (item.type == "id") {
		listId = item.prop;
	}
	//获取选中时需要的表头字段
	if (item.type != "workflowStatus" && item.type != "selection" && item.type != "index" && item.type != "operation") {
		tableHanderArr.push(item.prop);
	}
	if (item.edit) {
		tableHanderEditArr.push(item.prop);
	}
});

// 当前选中的所有ids(数组)，可根据项目自行配置id字段
const selectListIds = computed(() => {
	let ids = [];
	selectList.value.forEach(item => {
		ids.push(item[listId]);
	});
	return ids;
});

//快捷查询字段
params.jsonString = computed(() => {
	let jsonString = {
		cond: {}
	};
	for (let key in tablePropSearch) {
		if (tablePropSearch[key]) {
			jsonString.cond[key] = tablePropSearch[key] + "";
		}
	}
	return JSON.stringify(jsonString);
});

//获取数据源
const getTableList = async () => {
	//判断请求属性是否为空
	if (props.tableList.httpAttribute) {
		if (props.tableList.httpAttribute.baseParams) {
			for (let key in props.tableList.httpAttribute.baseParams) {
				params[key] = props.tableList.httpAttribute.baseParams[key];
			}
		}

		try {
			loading.value = true;
			const res = await http.post(props.tableList.httpAttribute.url, qs.stringify(params), config); // post 请求携带 表单 参数  ==>  application/x-www-form-urlencoded
			if (res) {
				//对数据源进行处理
				handleTableData(res);
			}
		} finally {
			loading.value = false;
		}
	}
};

//baseParams发生变化重新调用
const reuseTableList = async () => {
	let newBaseParams = props.tableList.httpAttribute.baseParams;
	for (let key in newBaseParams) {
		params[key] = newBaseParams[key];
	}
	try {
		loading.value = true;
		const res = await http.post(props.tableList.httpAttribute.url, qs.stringify(params), config); // post 请求携带 表单 参数  ==>  application/x-www-form-urlencoded
		if (res) {
			//对数据源进行处理
			handleTableData(res);
		}
	} finally {
		loading.value = false;
	}
};

//对数据源进行处理
const handleTableData = res => {
	if (props.tableList.httpAttribute.root) {
		if (res[props.tableList.httpAttribute.root]) {
			let tableData = res[props.tableList.httpAttribute.root];
			for (let i = 0; i < tableData.length; i++) {
				let item = tableData[i];
				if (item.retrieveflag == 1) {
					item.processflag = -1;
				} else {
					item.processflag = item.auditflag;
				}
				if (props.tableList.edit) {
					item.isEdit = {}; //可编辑字段
					item.editShow = {}; //可编辑字段显示隐藏
					item.rowIndex = i; //每行的索引
					item.editShowOriginal = {}; //数据源的原始值
					item.isOriginalChanged = {}; //数据是否被编辑改变
					tableHanderEditArr.forEach(item1 => {
						item.editShowOriginal[item1] = item[item1];
						item.isOriginalChanged[item1] = false;
						item.isEdit[item1] = true; //行的列设置可编辑
					});
				}
			}
			props.tableList.tableData = tableData;
			params.total = res[props.tableList.httpAttribute.root + "_num"];
		}
	} else {
		let tableData = [];
		if (Array.isArray(res)) {
			tableData = res;
		} else {
			tableData.push(res);
		}
		props.tableList.tableData = tableData;
	}

	//默认单选选中第一行
	tableRef.value.setCurrentRow(props.tableList.tableData[0]);
};

//下拉选择框字段显示
const selectText = (row, typeData) => {
	let text = row;
	for (let item of typeData) {
		if (item.value == row) {
			text = item.label;
			break;
		}
	}
	return text;
};

//审核状态显示
const workflowStatusText = row => {
	let text = "";
	if (row == 0) {
		text = i18n.t("AUDITFLAG_0");
	} else if (row == 1) {
		text = i18n.t("AUDITFLAG_1");
	} else if (row == 2) {
		text = i18n.t("AUDITFLAG_2");
	} else if (row == -1) {
		text = i18n.t("AUDITFLAG_9");
	}
	return text;
};

// // 保存选中的数据id,row-key就是要指定一个key标识这一行的数据
// const getRowKeys = (row) => {
// 	// return row.id
// };

//排序
const tableSor = tableProp => {
	sortvalue.value == "ascending" ? (sortvalue.value = "descending") : (sortvalue.value = "ascending");
	tableRef.value.sort(tableProp, sortvalue.value);
};

//当用户手动勾选数据行的 Checkbox 时触发的事件
const select = async (selection, row) => {
	//单选操作
	if (props.tableList.isRadio) {
		// 清除 所有勾选项
		await tableRef.value.clearSelection();
		// 当表格数据都没有被勾选的时候 就返回
		// 主要用于将当前勾选的表格状态清除
		if (selection.length == 0) return;
		await tableRef.value.toggleRowSelection(row, true);
	}
};

//当表格的当前行发生变化的时候会触发该事件
const currentChange = (currentRow, oldCurrentRow) => {
	//当前是编辑表格时,隐藏掉上一行的所有编辑项
	if (props.tableList.edit) {
		tableHanderEditArr.forEach(item => {
			if (oldCurrentRow) {
				oldCurrentRow.editShow[item] = false;
			}
		});
	}

	emits("currentChange", currentRow, oldCurrentRow);

	if (currentRow) {
	}
	if (oldCurrentRow) {
	}
};

// 表格某一行的单击事件
const rowClick = (row, column, event) => {
	emits("rowClick", row, column, event);

	//单选操作
	if (props.tableList.isRadio) {
		// 清除 所有勾选项
		tableRef.value.clearSelection();
		tableRef.value.toggleRowSelection(row, true);
	} else {
		// 清除 所有勾选项
		//tableRef.value.clearSelection();
		//tableRef.value.toggleRowSelection(row, true);
	}
};

// 赋值动态表单组件ref到变量
const setFormComponentRef = (el, key) => {
	if (el) {
		formComponentRef[key] = el;
	}
};

//当某个单元格被点击时会触发该事件
const cellClick = (row, column, cell, event) => {
	//当前是编辑表格时,
	if (props.tableList.edit) {
		tableHanderEditArr.forEach(item => {
			if (column.property != item) {
				//隐藏掉其他编辑项
				row.editShow[item] = false;
			}
		});
	}
	emits("cellClick", row, column, cell, event);
	//表格是否可编辑、列是否可编辑，当前行的当前列是否可编辑，当前行的当前列是否隐藏
	if (
		props.tableList.edit &&
		tableHanderEditArr.includes(column.property) &&
		row.isEdit[column.property] &&
		!row.editShow[column.property]
	) {
		row.editShow[column.property] = true;
		if (formComponentRef[row.rowIndex + column.property]) formComponentRef[row.rowIndex + column.property].focus();
	}
};

//单元格的 className 的回调方法，也可以使用字符串为所有单元格设置一个固定的 className。
const cellClassName = ({ row, column, rowIndex, columnIndex }) => {
	//当前是编辑表格时,
	if (props.tableList.edit && tableHanderEditArr.includes(column.property)) {
		//新值与原始值不一样时改变边框颜色
		if (row[column.property] != row.editShowOriginal[column.property]) {
			row.isOriginalChanged[column.property] = true; //标检为当前行改变了值
			return "edit-table-column-class"; // class名称
		} else {
			row.isOriginalChanged[column.property] = false;
		}
	}

	//当单元格是操作列的时候，修改样式
	// if (column.property == "operation") {
	// 	return "table-operationColumn-class"; // class名称
	// }
};

/**
 * @description 多选操作
 * @param {Array} rowArr 当前选择的所有数据
 * @return void
 */
const selectionChange = rowArr => {
	rowArr.length === 0 ? (isSelected.value = false) : (isSelected.value = true);
	selectRowArr.value = rowArr;
	//根据 表头的列字段，把勾选的数据源进行封装
	selectList.value = [];
	rowArr.forEach(item => {
		let obj = {};
		tableHanderArr.forEach(key => {
			obj[key] = item[key];
		});
		selectList.value.push(obj);
	});

	emits("selectionChange", rowArr);
};

// 如果当前表格为编辑表格，该方法为编辑后选中的数据源，一般用于保存
//返回数据改变后的行数据
const getEditSelectList = () => {
	//根据 表头的列字段，把改变后的行数据源进行封装
	//编辑改变值的数据列表
	const selecteditList = [];
	props.tableList.tableData.forEach(item => {
		let obj = {};
		for (let itemkey in item.isOriginalChanged) {
			if (item.isOriginalChanged[itemkey]) {
				tableHanderArr.forEach(key => {
					obj[key] = item[key];
				});
				break;
			}
		}
		if (Object.keys(obj).length > 0) {
			selecteditList.push(obj);
		}
	});
	return selecteditList;
};

//过滤
const tableFilter = () => {
	tablePropSearchShow.value = tablePropSearchShow.value ? false : true;
	tableRef.value.sort(props.tableList.tableColumns[1].prop, "");
};
//导出表格数据
const tableExport = () => {
	let tableColumns = props.tableList.tableColumns;
	let tableHander = {};
	tableColumns.forEach(item => {
		if (item.type != "selection" && item.type != "index" && item.type != "operation") {
			tableHander[item.prop] = item.label ? i18n.t(item.label) : item.title;
		}
	});
	exportDataSourceToExcel(props.tableList.tableData, tableHander, "tableExport");
};

//清空快捷查询值
const tableResetSearch = () => {
	for (let i in tablePropSearch) {
		tablePropSearch[i] = "";
	}
};

/**
 * @description 每页条数改变
 * @param {Number} val 当前条数
 * @return void
 * */
const handleSizeChange = val => {
	params.page = 1;
	params.limit = val;
	params.start = 0;
	getTableList();
};

/**
 * @description 当前页改变
 * @param {Number} val 当前页
 * @return void
 * */
const handleCurrentChange = val => {
	params.page = val;
	if (val == 1) {
		params.start = 0;
	} else {
		params.start = (val - 1) * params.limit;
	}
	getTableList();
};

//快捷查询
const quickQuery = () => {
	// let jsonString = {
	// 	cond: {}
	// };
	// for (let key in tablePropSearch) {
	// 	if (tablePropSearch[key]) {
	// 		jsonString.cond[key] = tablePropSearch[key] + "";
	// 	}
	// }
	// params.jsonString = JSON.stringify(jsonString);
	getTableList();
};

//链接详细信息
const linkDetailbg = (column, row) => {
	emits("linkDetailbg", column, row);
};

//工作流审核历史记录
const workflowStatus = (column, row) => {
	emits("workflowStatus", column, row);
};

//返回Table 的 refs
const getTablerefs = () => {
	return tableRef;
};

//添加行数据
const addRowData = srtrow => {
	let row = { rowIndex: props.tableList.tableData.length, editShow: {}, editShowOriginal: {}, isOriginalChanged: {}, isEdit: {} };
	for (let Columns of props.tableList.tableColumns) {
		if (Columns.prop) {
			if (srtrow && Object.keys(srtrow).length > 0 && srtrow[Columns.prop]) {
				row[Columns.prop] = srtrow[Columns.prop];
			} else {
				row[Columns.prop] = "";
			}
			row.editShowOriginal[Columns.prop] = "";
			row.isOriginalChanged[Columns.prop] = false;
			row.isEdit[Columns.prop] = true;
		}
	}
	props.tableList.tableData.unshift(row);
};

// 操作列 高度
const operationColumnHeight = computed(() => {
	if (globalStore.assemblySize == "small") {
		return 31;
	} else if (globalStore.assemblySize == "large") {
		return 47;
	} else {
		return 39;
	}
});

//页面初始化渲染完成执行
onMounted(() => {
	//面初始化渲染完成 是否调请求
	if (props.tableList.isRequest) {
		getTableList();
	}
});

//注册emit // 抛出事件
const emits = defineEmits(["currentChange", "linkDetailbg", "workflowStatus", "rowClick", "cellClick", "selectionChange"]);
// 暴露给父组件的参数和方法
defineExpose({
	getTableList, //调用接口
	getTablerefs, // ref
	addRowData, //添加行数据
	tableHanderEditArr, //获取表头可编辑字段
	formComponentRef, //可编辑时，表单组件ref数组
	getEditSelectList, //获取编辑后的数据行
	selectListIds, // 获取选中的id
	selectList, //获取选中的数据行
	selectRowArr, // 获取选中的原始数据
	reuseTableList // 重新调用接口
});
</script>

<style scoped lang="scss">
/*隐藏表头复选框*/
:deep(.el-table__header .el-table-column--selection .cell .el-checkbox) {
	display: v-bind(RadioDisplay);
}
</style>
<style lang="scss">
.edit-table-column-class {
	border-left-style: solid;
	border-left-width: 3px;
	border-left-color: #f56c6c !important;
}

.table-operationColumn-class {
	padding: 0px 0 !important;
}
</style>
